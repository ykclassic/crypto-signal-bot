name: Hourly Crypto Bot Cycle

on:
  schedule:
    # Run every hour at minute 0
    - cron: '0 * * * *'
  
  # Allow manual triggering from GitHub UI
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Prevent hung processes
    
    permissions:
      contents: write  # Required for database commit
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone for speed
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install System Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libhdf5-dev \
            libatlas-base-dev
      
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          
          # Core dependencies (always needed)
          pip install --no-cache-dir \
            pandas==2.0.3 \
            pandas-ta==0.3.14b0 \
            ccxt==4.2.25 \
            requests==2.31.0 \
            python-dotenv==1.0.0 \
            newsapi-python==0.2.7 \
            vaderSentiment==3.3.2 \
            tweepy==4.14.0
          
          # TensorFlow CPU (lighter than full version)
          pip install --no-cache-dir tensorflow-cpu==2.15.0
          
          # Transformers for AI sentiment
          pip install --no-cache-dir transformers==4.36.0
          
          # Discord webhook support
          pip install --no-cache-dir discord-webhook==1.3.0
          
          # Install any additional requirements
          if [ -f requirements.txt ]; then
            pip install --no-cache-dir -r requirements.txt
          fi
          
          echo "✅ All dependencies installed"
      
      - name: Verify Installation
        run: |
          echo "Verifying critical modules..."
          python -c "
          import sys
          import importlib
          
          required_modules = [
              'pandas',
              'pandas_ta',
              'ccxt',
              'requests',
              'tensorflow',
              'transformers',
              'newsapi',
              'vaderSentiment',
              'tweepy'
          ]
          
          missing = []
          for module in required_modules:
              try:
                  importlib.import_module(module)
                  print(f'✅ {module}')
              except ImportError:
                  missing.append(module)
                  print(f'❌ {module}')
          
          if missing:
              print(f'\n⚠️  Missing modules: {missing}')
              sys.exit(1)
          else:
              print('\n✅ All required modules verified')
          "
      
      - name: Create Required Directories
        run: |
          mkdir -p logs
          mkdir -p data
          touch signals.db  # Ensure database file exists
      
      - name: Run Trading Bot
        env:
          # Hugging Face token for model downloads
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HUGGINGFACE_TOKEN: ${{ secrets.HF_TOKEN }}
          
          # Exchange API credentials
          XT_API_KEY: ${{ secrets.XT_API_KEY }}
          XT_SECRET: ${{ secrets.XT_SECRET }}
          BITGET_API_KEY: ${{ secrets.BITGET_API_KEY }}
          BITGET_SECRET: ${{ secrets.BITGET_SECRET }}
          GATEIO_API_KEY: ${{ secrets.GATEIO_API_KEY }}
          GATEIO_SECRET: ${{ secrets.GATEIO_SECRET }}
          
          # Data source APIs
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
          
          # Alert system
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          
          # Mapped variables for config.py
          EXCHANGE_API_KEYS_XT_APIKEY: ${{ secrets.XT_API_KEY }}
          EXCHANGE_API_KEYS_XT_SECRET: ${{ secrets.XT_SECRET }}
          EXCHANGE_API_KEYS_BITGET_APIKEY: ${{ secrets.BITGET_API_KEY }}
          EXCHANGE_API_KEYS_BITGET_SECRET: ${{ secrets.BITGET_SECRET }}
          EXCHANGE_API_KEYS_GATEIO_APIKEY: ${{ secrets.GATEIO_API_KEY }}
          EXCHANGE_API_KEYS_GATEIO_SECRET: ${{ secrets.GATEIO_SECRET }}
          
          # Configuration
          LOG_LEVEL: ${{ inputs.debug_mode && 'DEBUG' || 'INFO' }}
          DB_PATH: ./signals.db
          
          # Prevent TensorFlow warnings
          TF_CPP_MIN_LOG_LEVEL: '2'
          
        run: |
          echo "Starting trading bot at $(date)"
          python main.py 2>&1 | tee logs/bot_run_$(date +%Y%m%d_%H%M%S).log
          echo "Bot execution completed at $(date)"
      
      - name: Check Bot Status
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "✅ Bot executed successfully"
          else
            echo "❌ Bot execution failed"
            exit 1
          fi
      
      - name: Archive Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-logs-${{ github.run_number }}
          path: logs/
          retention-days: 7
      
      - name: Sync Database to Repository
        if: success()
        run: |
          # Configure git
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add database file
          git add signals.db
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No database changes to commit"
          else
            git commit -m "chore: update signals database [bot run #${{ github.run_number }}]"
            
            # Retry push up to 3 times (in case of concurrent runs)
            for i in 1 2 3; do
              if git push; then
                echo "✅ Database pushed successfully"
                break
              else
                echo "⚠️  Push attempt $i failed, retrying..."
                git pull --rebase
                sleep 5
              fi
            done
          fi
      
      - name: Send Success Notification
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "✅ Bot Cycle Complete",
                  "description": "Trading bot executed successfully",
                  "color": 3066993,
                  "fields": [
                    {
                      "name": "Run Number",
                      "value": "#${{ github.run_number }}",
                      "inline": true
                    },
                    {
                      "name": "Timestamp",
                      "value": "'"$(date -u +"%Y-%m-%d %H:%M:%S UTC")"'",
                      "inline": true
                    }
                  ],
                  "footer": {
                    "text": "GitHub Actions"
                  }
                }]
              }'
          fi
      
      - name: Send Failure Notification
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "❌ Bot Cycle Failed",
                  "description": "Trading bot encountered an error",
                  "color": 15158332,
                  "fields": [
                    {
                      "name": "Run Number",
                      "value": "#${{ github.run_number }}",
                      "inline": true
                    },
                    {
                      "name": "Timestamp",
                      "value": "'"$(date -u +"%Y-%m-%d %H:%M:%S UTC")"'",
                      "inline": true
                    },
                    {
                      "name": "View Logs",
                      "value": "[Click here](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                      "inline": false
                    }
                  ],
                  "footer": {
                    "text": "GitHub Actions"
                  }
                }]
              }'
          fi
      
      - name: Cleanup Old Logs
        if: always()
        run: |
          # Keep only last 5 log files
          cd logs 2>/dev/null || exit 0
          ls -t bot_run_*.log 2>/dev/null | tail -n +6 | xargs rm -f || true
```

---

## Key Improvements

### ✅ **Reliability**
- **Timeout protection** (15 minutes max)
- **Retry logic** for database pushes
- **Graceful failure handling**

### ✅ **Performance**
- **Caching** pip packages and dependencies
- **Shallow git clone** for faster checkout
- **Optimized installations** with `--no-cache-dir`

### ✅ **Monitoring**
- **Status notifications** via Discord (success/failure)
- **Log archiving** with 7-day retention
- **Run number tracking**

### ✅ **Debugging**
- **Manual trigger** with optional debug mode
- **Detailed verification** of module installation
- **Timestamped logs**

### ✅ **Safety**
- **Environment variable validation**
- **Database existence check**
- **Conflict resolution** for concurrent runs

---

## Required GitHub Secrets

Set these in your repository settings (`Settings > Secrets and variables > Actions`):
```
Required:
- HF_TOKEN               # Hugging Face API token
- XT_API_KEY            # XT.com exchange API key
- XT_SECRET             # XT.com exchange secret
- DISCORD_WEBHOOK_URL   # Discord webhook for alerts

Optional (for additional exchanges):
- BITGET_API_KEY
- BITGET_SECRET
- GATEIO_API_KEY
- GATEIO_SECRET
- NEWS_API_KEY
- TWITTER_BEARER_TOKEN
